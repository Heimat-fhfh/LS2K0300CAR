<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能车Web控制界面</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js CDN for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .control-panel {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .slider-container {
            margin: 15px 0;
            text-align: center;
        }
        .slider-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            position: relative;
        }
        .data-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .config-editor {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-left: 3px solid #007bff;
        }
        .sensor-checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
        .btn-hold:active {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center my-4">智能车Web控制界面</h1>
        
        <!-- 控制面板 -->
        <div class="row">
            <div class="col-md-12">
                <div class="control-panel">
                    <h3>车辆控制</h3>
                    
                    <div class="row">
                        <!-- 前进后退滑块 -->
                        <div class="col-md-6">
                            <div class="slider-container">
                                <span class="slider-label">前进/后退功率 (-100 到 100)</span>
                                <input type="range" class="form-range" id="powerSlider" min="-100" max="100" value="0" 
                                       oninput="updatePowerValue(this.value)" ontouchmove="sendPowerCommandDebounced(this.value)">
                                <div class="mt-2">
                                    <span class="badge bg-primary">当前值: <span id="powerValue">0</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 转向滑块 -->
                        <div class="col-md-6">
                            <div class="slider-container">
                                <span class="slider-label">转向角度 (0 到 360度)</span>
                                <input type="range" class="form-range" id="steerSlider" min="0" max="360" value="180" 
                                       oninput="updateSteerValue(this.value)" ontouchmove="sendSteerCommandDebounced(this.value)">
                                <div class="mt-2">
                                    <span class="badge bg-success">当前值: <span id="steerValue">180</span>°</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <button class="btn btn-danger btn-lg w-100" onclick="stopCar()">关闭智能车</button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning btn-lg w-100 btn-hold" 
                                    id="buzzerBtn"
                                    onmousedown="startBuzzer()" 
                                    onmouseup="stopBuzzer()" 
                                    ontouchstart="startBuzzer()" 
                                    ontouchend="stopBuzzer()">蜂鸣器 (按住开启)</button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-secondary btn-lg w-100" onclick="startSSE()">开始接收数据</button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-info btn-lg w-100" onclick="stopSSE()">停止接收数据</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据显示区域 -->
        <div class="row">
            <!-- 第一栏：传感器数据图表 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>传感器数据图表</h5>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label class="form-label">显示范围 (秒):</label>
                                <input type="number" class="form-control form-control-sm" id="displayRange" value="30" min="10" max="300" onchange="updateChartSettings()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">显示密度 (点/秒):</label>
                                <input type="number" class="form-control form-control-sm" id="displayDensity" value="2" min="1" max="10" onchange="updateChartSettings()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">自动调整Y轴:</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoScaleY" checked onchange="updateChartSettings()">
                                    <label class="form-check-label" for="autoScaleY">启用</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="sensor-checkbox-group">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>陀螺仪数据:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gyroX1" checked onchange="toggleChartData('gyroX1', this.checked)">
                                        <label class="form-check-label" for="gyroX1"><span class="color-indicator" style="background-color: #FF6384;"></span>陀螺仪X1</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gyroY1" checked onchange="toggleChartData('gyroY1', this.checked)">
                                        <label class="form-check-label" for="gyroY1"><span class="color-indicator" style="background-color: #36A2EB;"></span>陀螺仪Y1</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gyroZ1" checked onchange="toggleChartData('gyroZ1', this.checked)">
                                        <label class="form-check-label" for="gyroZ1"><span class="color-indicator" style="background-color: #FFCE56;"></span>陀螺仪Z1</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gyroX2" checked onchange="toggleChartData('gyroX2', this.checked)">
                                        <label class="form-check-label" for="gyroX2"><span class="color-indicator" style="background-color: #4BC0C0;"></span>陀螺仪X2</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gyroY2" checked onchange="toggleChartData('gyroY2', this.checked)">
                                        <label class="form-check-label" for="gyroY2"><span class="color-indicator" style="background-color: #9966FF;"></span>陀螺仪Y2</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gyroZ2" checked onchange="toggleChartData('gyroZ2', this.checked)">
                                        <label class="form-check-label" for="gyroZ2"><span class="color-indicator" style="background-color: #FF9F40;"></span>陀螺仪Z2</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>编码器数据:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="encoderLeft" checked onchange="toggleChartData('encoderLeft', this.checked)">
                                        <label class="form-check-label" for="encoderLeft"><span class="color-indicator" style="background-color: #C9CBCF;"></span>编码器左</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="encoderRight" checked onchange="toggleChartData('encoderRight', this.checked)">
                                        <label class="form-check-label" for="encoderRight"><span class="color-indicator" style="background-color: #7F7F7F;"></span>编码器右</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="sensorChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">当前原始数据:</label>
                            <div class="data-display" id="currentRawData">
                                等待数据...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第二栏：配置文件管理 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>配置文件管理</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">选择配置文件:</label>
                            <select class="form-select" id="configSelect" onchange="loadConfig()">
                                <option value="config_0.json">config_0.json</option>
                                <option value="config_1.json">config_1.json</option>
                                <option value="config_2.json">config_2.json</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">配置参数编辑:</label>
                            <textarea class="form-control config-editor" id="configEditor" rows="15" placeholder="配置参数将在此显示..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-primary w-100" onclick="saveConfig()">保存修改</button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-success w-100" onclick="reloadConfig()">重新加载参数</button>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label">上传配置文件:</label>
                            <input type="file" class="form-control" id="configUpload" accept=".json">
                        </div>
                        <button class="btn btn-info w-100" onclick="uploadConfig()">上传配置文件</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第三栏：日志信息 -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>系统日志</h5>
                    </div>
                    <div class="card-body">
                        <div class="data-display" id="logDisplay">
                            <div class="log-entry text-muted">系统启动，等待日志信息...</div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">清空日志</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportLogs()">导出日志</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let eventSource = null;
        let sensorChart = null;
        let chartData = {
            timestamps: [],
            gyroX1: [],
            gyroY1: [],
            gyroZ1: [],
            gyroX2: [],
            gyroY2: [],
            gyroZ2: [],
            encoderLeft: [],
            encoderRight: []
        };
        
        // 颜色配置
        const chartColors = {
            gyroX1: '#FF6384',
            gyroY1: '#36A2EB',
            gyroZ1: '#FFCE56',
            gyroX2: '#4BC0C0',
            gyroY2: '#9966FF',
            gyroZ2: '#FF9F40',
            encoderLeft: '#C9CBCF',
            encoderRight: '#7F7F7F'
        };
        
        // 显示状态
        const displayStates = {
            gyroX1: true,
            gyroY1: true,
            gyroZ1: true,
            gyroX2: true,
            gyroY2: true,
            gyroZ2: true,
            encoderLeft: true,
            encoderRight: true
        };

        // 更新功率值显示
        function updatePowerValue(value) {
            document.getElementById('powerValue').textContent = value;
        }

        // 更新转向值显示
        function updateSteerValue(value) {
            document.getElementById('steerValue').textContent = value;
        }

        // 滑块拖动状态
        let isPowerSliderDragging = false;
        let isSteerSliderDragging = false;
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 发送功率命令（带防抖）
        const sendPowerCommandDebounced = debounce(function(value) {
            if (isPowerSliderDragging) {
                console.log('发送功率命令:', value);
                fetch('/api/power', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ power: parseInt(value) })
                }).catch(err => console.error('功率命令发送失败:', err));
            }
        }, 100); // 100ms防抖

        // 发送转向命令（带防抖）
        const sendSteerCommandDebounced = debounce(function(value) {
            if (isSteerSliderDragging) {
                console.log('发送转向命令:', value);
                fetch('/api/steer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ angle: parseInt(value) })
                }).catch(err => console.error('转向命令发送失败:', err));
            }
        }, 100); // 100ms防抖

        // 原始发送功率命令（用于change事件）
        function sendPowerCommand(value) {
            console.log('发送功率命令（最终）:', value);
            fetch('/api/power', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ power: parseInt(value) })
            }).catch(err => console.error('功率命令发送失败:', err));
        }

        // 原始发送转向命令（用于change事件）
        function sendSteerCommand(value) {
            console.log('发送转向命令（最终）:', value);
            fetch('/api/steer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ angle: parseInt(value) })
            }).catch(err => console.error('转向命令发送失败:', err));
        }

        // 关闭智能车
        function stopCar() {
            console.log('发送停止命令');
            fetch('/api/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: 'stop' })
            }).then(() => {
                addLog('智能车已停止');
            }).catch(err => {
                console.error('停止命令发送失败:', err);
                addLog('停止命令发送失败: ' + err.message);
            });
        }

        // 开启蜂鸣器
        function startBuzzer() {
            console.log('开启蜂鸣器');
            document.getElementById('buzzerBtn').classList.add('active');
            fetch('/api/buzzer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ state: true })
            }).then(() => {
                addLog('蜂鸣器已开启');
            }).catch(err => {
                console.error('蜂鸣器开启失败:', err);
                addLog('蜂鸣器开启失败: ' + err.message);
            });
        }

        // 关闭蜂鸣器
        function stopBuzzer() {
            console.log('关闭蜂鸣器');
            document.getElementById('buzzerBtn').classList.remove('active');
            fetch('/api/buzzer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ state: false })
            }).then(() => {
                addLog('蜂鸣器已关闭');
            }).catch(err => {
                console.error('蜂鸣器关闭失败:', err);
                addLog('蜂鸣器关闭失败: ' + err.message);
            });
        }

        // SSE相关函数
        function startSSE() {
            if (eventSource) {
                return;
            }
            
            addLog('正在连接数据流...');
            
            // 创建EventSource连接
            eventSource = new EventSource('/events');
            
            // 监听默认消息事件
            eventSource.onmessage = function(event) {
                handleSensorData(event.data);
            };
            
            // 监听自定义事件
            eventSource.addEventListener('sensor-data', function(event) {
                handleSensorData(event.data);
            });
            
            eventSource.addEventListener('log-message', function(event) {
                try {
                    const logData = JSON.parse(event.data);
                    addLog(logData.message || event.data);
                } catch (e) {
                    addLog(event.data);
                }
            });
            
            eventSource.addEventListener('end', function(event) {
                addLog('数据流结束');
                eventSource.close();
                eventSource = null;
            });
            
            // 错误处理
            eventSource.onerror = function(event) {
                addLog('连接错误或已关闭');
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            };
        }

        function stopSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                addLog('已停止接收数据');
            }
        }

        // 处理传感器数据
        function handleSensorData(data) {
            try {
                const sensorData = JSON.parse(data);
                
                // 更新当前原始数据显示
                document.getElementById('currentRawData').textContent = JSON.stringify(sensorData, null, 2);
                
                // 更新图表数据
                updateChartData(sensorData);
                
                addLog('接收到传感器数据');
            } catch (e) {
                console.error('解析传感器数据失败:', e);
                document.getElementById('currentRawData').textContent = data;
            }
        }

        // 更新图表数据
        function updateChartData(data) {
            const timestamp = Date.now();
            
            // 添加时间戳
            chartData.timestamps.push(timestamp);
            
            // 更新传感器数据
            if (data.gyro_x1 !== undefined) {
                chartData.gyroX1.push(data.gyro_x1);
            }
            if (data.gyro_y1 !== undefined) {
                chartData.gyroY1.push(data.gyro_y1);
            }
            if (data.gyro_z1 !== undefined) {
                chartData.gyroZ1.push(data.gyro_z1);
            }
            if (data.gyro_x2 !== undefined) {
                chartData.gyroX2.push(data.gyro_x2);
            }
            if (data.gyro_y2 !== undefined) {
                chartData.gyroY2.push(data.gyro_y2);
            }
            if (data.gyro_z2 !== undefined) {
                chartData.gyroZ2.push(data.gyro_z2);
            }
            if (data.encoder_left !== undefined) {
                chartData.encoderLeft.push(data.encoder_left);
            }
            if (data.encoder_right !== undefined) {
                chartData.encoderRight.push(data.encoder_right);
            }
            
            // 限制数据量，只保留最近的数据
            const displayRange = parseInt(document.getElementById('displayRange').value) * 1000; // 转换为毫秒
            const cutoffTime = timestamp - displayRange;
            
            // 找到第一个大于cutoffTime的时间戳索引
            let cutoffIndex = 0;
            for (let i = 0; i < chartData.timestamps.length; i++) {
                if (chartData.timestamps[i] > cutoffTime) {
                    cutoffIndex = i;
                    break;
                }
            }
            
            // 裁剪数据
            if (cutoffIndex > 0) {
                chartData.timestamps = chartData.timestamps.slice(cutoffIndex);
                chartData.gyroX1 = chartData.gyroX1.slice(cutoffIndex);
                chartData.gyroY1 = chartData.gyroY1.slice(cutoffIndex);
                chartData.gyroZ1 = chartData.gyroZ1.slice(cutoffIndex);
                chartData.gyroX2 = chartData.gyroX2.slice(cutoffIndex);
                chartData.gyroY2 = chartData.gyroY2.slice(cutoffIndex);
                chartData.gyroZ2 = chartData.gyroZ2.slice(cutoffIndex);
                chartData.encoderLeft = chartData.encoderLeft.slice(cutoffIndex);
                chartData.encoderRight = chartData.encoderRight.slice(cutoffIndex);
            }
            
            // 根据显示密度进行采样
            const density = parseInt(document.getElementById('displayDensity').value);
            if (density > 0 && chartData.timestamps.length > density * (displayRange / 1000)) {
                const sampleInterval = Math.floor(chartData.timestamps.length / (density * (displayRange / 1000)));
                if (sampleInterval > 1) {
                    const sampledTimestamps = [];
                    const sampledGyroX1 = [];
                    const sampledGyroY1 = [];
                    const sampledGyroZ1 = [];
                    const sampledGyroX2 = [];
                    const sampledGyroY2 = [];
                    const sampledGyroZ2 = [];
                    const sampledEncoderLeft = [];
                    const sampledEncoderRight = [];
                    
                    for (let i = 0; i < chartData.timestamps.length; i += sampleInterval) {
                        sampledTimestamps.push(chartData.timestamps[i]);
                        sampledGyroX1.push(chartData.gyroX1[i]);
                        sampledGyroY1.push(chartData.gyroY1[i]);
                        sampledGyroZ1.push(chartData.gyroZ1[i]);
                        sampledGyroX2.push(chartData.gyroX2[i]);
                        sampledGyroY2.push(chartData.gyroY2[i]);
                        sampledGyroZ2.push(chartData.gyroZ2[i]);
                        sampledEncoderLeft.push(chartData.encoderLeft[i]);
                        sampledEncoderRight.push(chartData.encoderRight[i]);
                    }
                    
                    chartData.timestamps = sampledTimestamps;
                    chartData.gyroX1 = sampledGyroX1;
                    chartData.gyroY1 = sampledGyroY1;
                    chartData.gyroZ1 = sampledGyroZ1;
                    chartData.gyroX2 = sampledGyroX2;
                    chartData.gyroY2 = sampledGyroY2;
                    chartData.gyroZ2 = sampledGyroZ2;
                    chartData.encoderLeft = sampledEncoderLeft;
                    chartData.encoderRight = sampledEncoderRight;
                }
            }
            
            // 更新图表显示
            renderChart();
        }

        // 渲染图表
        function renderChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            // 准备数据集
            const datasets = [];
            
            if (displayStates.gyroX1 && chartData.gyroX1.length > 0) {
                datasets.push({
                    label: '陀螺仪X1',
                    data: chartData.gyroX1,
                    borderColor: chartColors.gyroX1,
                    backgroundColor: chartColors.gyroX1 + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.gyroY1 && chartData.gyroY1.length > 0) {
                datasets.push({
                    label: '陀螺仪Y1',
                    data: chartData.gyroY1,
                    borderColor: chartColors.gyroY1,
                    backgroundColor: chartColors.gyroY1 + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.gyroZ1 && chartData.gyroZ1.length > 0) {
                datasets.push({
                    label: '陀螺仪Z1',
                    data: chartData.gyroZ1,
                    borderColor: chartColors.gyroZ1,
                    backgroundColor: chartColors.gyroZ1 + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.gyroX2 && chartData.gyroX2.length > 0) {
                datasets.push({
                    label: '陀螺仪X2',
                    data: chartData.gyroX2,
                    borderColor: chartColors.gyroX2,
                    backgroundColor: chartColors.gyroX2 + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.gyroY2 && chartData.gyroY2.length > 0) {
                datasets.push({
                    label: '陀螺仪Y2',
                    data: chartData.gyroY2,
                    borderColor: chartColors.gyroY2,
                    backgroundColor: chartColors.gyroY2 + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.gyroZ2 && chartData.gyroZ2.length > 0) {
                datasets.push({
                    label: '陀螺仪Z2',
                    data: chartData.gyroZ2,
                    borderColor: chartColors.gyroZ2,
                    backgroundColor: chartColors.gyroZ2 + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.encoderLeft && chartData.encoderLeft.length > 0) {
                datasets.push({
                    label: '编码器左',
                    data: chartData.encoderLeft,
                    borderColor: chartColors.encoderLeft,
                    backgroundColor: chartColors.encoderLeft + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            if (displayStates.encoderRight && chartData.encoderRight.length > 0) {
                datasets.push({
                    label: '编码器右',
                    data: chartData.encoderRight,
                    borderColor: chartColors.encoderRight,
                    backgroundColor: chartColors.encoderRight + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                });
            }
            
            // 创建或更新图表
            if (!sensorChart) {
                sensorChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.timestamps.map(t => new Date(t).toLocaleTimeString()),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '数值'
                                },
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'nearest'
                        }
                    }
                });
            } else {
                sensorChart.data.labels = chartData.timestamps.map(t => new Date(t).toLocaleTimeString());
                sensorChart.data.datasets = datasets;
                sensorChart.update('none');
            }
            
            // 自动调整Y轴范围
            if (document.getElementById('autoScaleY').checked) {
                let minVal = Infinity;
                let maxVal = -Infinity;
                
                datasets.forEach(dataset => {
                    if (dataset.data.length > 0) {
                        const datasetMin = Math.min(...dataset.data);
                        const datasetMax = Math.max(...dataset.data);
                        minVal = Math.min(minVal, datasetMin);
                        maxVal = Math.max(maxVal, datasetMax);
                    }
                });
                
                if (minVal !== Infinity && maxVal !== -Infinity) {
                    const padding = (maxVal - minVal) * 0.1;
                    sensorChart.options.scales.y.min = minVal - padding;
                    sensorChart.options.scales.y.max = maxVal + padding;
                    sensorChart.update();
                }
            }
        }

        // 切换图表数据显示
        function toggleChartData(key, visible) {
            displayStates[key] = visible;
            if (sensorChart) {
                renderChart();
            }
        }

        // 更新图表设置
        function updateChartSettings() {
            if (sensorChart) {
                renderChart();
            }
        }

        // 加载配置文件
        function loadConfig() {
            const configFile = document.getElementById('configSelect').value;
            fetch(`/api/config/${configFile}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('configEditor').value = JSON.stringify(data, null, 2);
                    addLog(`已加载配置文件: ${configFile}`);
                })
                .catch(err => {
                    console.error('加载配置失败:', err);
                    addLog('加载配置失败: ' + err.message);
                });
        }

        // 保存配置
        function saveConfig() {
            const configFile = document.getElementById('configSelect').value;
            const configText = document.getElementById('configEditor').value;
            
            try {
                const configData = JSON.parse(configText);
                fetch(`/api/config/${configFile}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                })
                .then(response => {
                    if (response.ok) {
                        addLog(`配置已保存到: ${configFile}`);
                    } else {
                        throw new Error('保存失败');
                    }
                })
                .catch(err => {
                    console.error('保存配置失败:', err);
                    addLog('保存配置失败: ' + err.message);
                });
            } catch (e) {
                addLog('配置格式错误: ' + e.message);
            }
        }

        // 重新加载配置
        function reloadConfig() {
            const configFile = document.getElementById('configSelect').value;
            fetch('/api/reload-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ config_file: configFile })
            })
            .then(() => {
                addLog('配置已重新加载');
            })
            .catch(err => {
                console.error('重新加载配置失败:', err);
                addLog('重新加载配置失败: ' + err.message);
            });
        }

        // 上传配置文件
        function uploadConfig() {
            const fileInput = document.getElementById('configUpload');
            const file = fileInput.files[0];
            if (!file) {
                addLog('请选择要上传的配置文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/upload-config', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    addLog('配置文件上传成功');
                    loadConfig(); // 重新加载配置列表
                } else {
                    throw new Error('上传失败');
                }
            })
            .catch(err => {
                console.error('上传配置失败:', err);
                addLog('上传配置失败: ' + err.message);
            });
        }

        // 添加日志
        function addLog(message) {
            const logDisplay = document.getElementById('logDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            logDisplay.insertBefore(logEntry, logDisplay.firstChild);
            
            // 限制日志数量，防止过多占用内存
            if (logDisplay.children.length > 100) {
                logDisplay.removeChild(logDisplay.lastChild);
            }
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('logDisplay').innerHTML = '<div class="log-entry text-muted">日志已清空</div>';
        }

        // 导出日志
        function exportLogs() {
            const logEntries = document.querySelectorAll('#logDisplay .log-entry');
            let logText = '智能车系统日志\n' + '='.repeat(50) + '\n\n';
            
            logEntries.forEach(entry => {
                logText += entry.textContent + '\n';
            });
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smartcar_logs_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addLog('日志已导出');
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载默认配置
            loadConfig();
            
            // 为配置选择下拉框添加事件监听
            document.getElementById('configSelect').addEventListener('change', loadConfig);
            
            // 初始化滑块事件
            const powerSlider = document.getElementById('powerSlider');
            const steerSlider = document.getElementById('steerSlider');
            
            // 功率滑块事件
            powerSlider.addEventListener('mousedown', function() {
                isPowerSliderDragging = true;
            });
            
            powerSlider.addEventListener('mouseup', function() {
                isPowerSliderDragging = false;
                // 鼠标抬起时发送最终值
                sendPowerCommand(this.value);
            });
            
            powerSlider.addEventListener('change', function() {
                sendPowerCommand(this.value);
            });
            
            // 转向滑块事件
            steerSlider.addEventListener('mousedown', function() {
                isSteerSliderDragging = true;
            });
            
            steerSlider.addEventListener('mouseup', function() {
                isSteerSliderDragging = false;
                // 鼠标抬起时发送最终值
                sendSteerCommand(this.value);
            });
            
            steerSlider.addEventListener('change', function() {
                sendSteerCommand(this.value);
            });
            
            // 触摸事件支持
            powerSlider.addEventListener('touchstart', function() {
                isPowerSliderDragging = true;
            });
            
            powerSlider.addEventListener('touchend', function() {
                isPowerSliderDragging = false;
                sendPowerCommand(this.value);
            });
            
            steerSlider.addEventListener('touchstart', function() {
                isSteerSliderDragging = true;
            });
            
            steerSlider.addEventListener('touchend', function() {
                isSteerSliderDragging = false;
                sendSteerCommand(this.value);
            });
            
            // 初始化图表
            renderChart();
        });

        // 页面卸载时关闭SSE连接
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
